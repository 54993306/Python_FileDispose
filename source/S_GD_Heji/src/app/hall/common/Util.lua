
local CURRENT_MODULE_NAME = ...

CURRENT_MODULE_NAME = string.sub(CURRENT_MODULE_NAME, 1, -6);

require(CURRENT_MODULE_NAME .. ".ToolKit");
require(CURRENT_MODULE_NAME .. ".Log");
require(CURRENT_MODULE_NAME .. ".UIWndBase");
require(CURRENT_MODULE_NAME .. ".UIManager");
require(CURRENT_MODULE_NAME .. ".Toast");
require(CURRENT_MODULE_NAME .. ".LoadingView");
require(CURRENT_MODULE_NAME .. ".CommonDialog");
require(CURRENT_MODULE_NAME .. ".LibDropDownItem");
require(CURRENT_MODULE_NAME .. ".IGameBase");
require(CURRENT_MODULE_NAME .. ".Deque");
require(CURRENT_MODULE_NAME .. ".PageViewWnd");
require(CURRENT_MODULE_NAME .. ".SliderIndicatorSprite");
require(CURRENT_MODULE_NAME .. ".SliderIndicatorWnd");

local kTradChinese = "汏熋僟噐亾錒皚藹礙愛噯嬡璦曖靄諳銨鵪骯襖奧媼驁鰲壩罷鈀擺敗唄頒辦絆鈑幫綁鎊謗剝飽寶報鮑鴇齙輩貝鋇狽備憊鵯賁錛繃筆畢斃幣閉蓽嗶潷鉍篳蹕邊編貶變辯辮芐緶籩標驃颮飆鏢鑣鰾鱉別癟瀕濱賓擯儐繽檳殯臏鑌髕鬢餅稟撥缽鉑駁餑鈸鵓補鈽財參蠶殘慚慘燦驂黲蒼艙倉滄廁側冊測惻層詫鍤儕釵攙摻蟬饞讒纏鏟產闡顫囅諂讖蕆懺嬋驏覘禪鐔場嘗長償腸廠暢倀萇悵閶鯧鈔車徹硨塵陳襯傖諶櫬磣齔撐稱懲誠騁棖檉鋮鐺癡遲馳恥齒熾飭鴟沖衝蟲寵銃疇躊籌綢儔幬讎櫥廚鋤雛礎儲觸處芻絀躕傳釧瘡闖創愴錘綞純鶉綽輟齪辭詞賜鶿聰蔥囪從叢蓯驄樅湊輳躥竄攛錯銼鹺達噠韃帶貸駘紿擔單鄲撣膽憚誕彈殫賧癉簞當擋黨蕩檔讜碭襠搗島禱導盜燾燈鄧鐙敵滌遞締糴詆諦綈覿鏑顛點墊電巔鈿癲釣調銚鯛諜疊鰈釘頂錠訂鋌丟銩東動棟凍崠鶇竇犢獨讀賭鍍瀆櫝牘篤黷鍛斷緞籪兌隊對懟鐓噸頓鈍燉躉奪墮鐸鵝額訛惡餓諤堊閼軛鋨鍔鶚顎顓鱷誒兒爾餌貳邇鉺鴯鮞發罰閥琺礬釩煩販飯訪紡鈁魴飛誹廢費緋鐨鯡紛墳奮憤糞僨豐楓鋒風瘋馮縫諷鳳灃膚輻撫輔賦復負訃婦縛鳧駙紱紼賻麩鮒鰒釓該鈣蓋賅桿趕稈贛尷搟紺岡剛鋼綱崗戇鎬睪誥縞鋯擱鴿閣鉻個紇鎘潁給亙賡綆鯁龔宮鞏貢鉤溝茍構購夠詬緱覯蠱顧詁轂鈷錮鴣鵠鶻剮掛鴰摑關觀館慣貫詿摜鸛鰥廣獷規歸龜閨軌詭貴劊匭劌媯檜鮭鱖輥滾袞緄鯀鍋國過堝咼幗槨蟈鉿駭韓漢闞絎頡號灝顥閡鶴賀訶闔蠣橫轟鴻紅黌訌葒閎鱟壺護滬戶滸鶘嘩華畫劃話驊樺鏵懷壞歡環還緩換喚瘓煥渙奐繯鍰鯇黃謊鰉揮輝毀賄穢會燴匯諱誨繪詼薈噦澮繢琿暉葷渾諢餛閽獲貨禍鈥鑊擊機積饑跡譏雞績緝極輯級擠幾薊劑濟計記際繼紀訐詰薺嘰嚌驥璣覬齏磯羈蠆躋霽鱭鯽夾莢頰賈鉀價駕郟浹鋏鎵蟯殲監堅箋間艱緘繭檢堿鹼揀撿簡儉減薦檻鑒踐賤見鍵艦劍餞漸濺澗諫縑戔戩瞼鶼筧鰹韉將漿蔣槳獎講醬絳韁膠澆驕嬌攪鉸矯僥腳餃繳絞轎較撟嶠鷦鮫階節潔結誡屆癤頜鮚緊錦僅謹進晉燼盡勁荊莖巹藎饉縉贐覲鯨驚經頸靜鏡徑痙競凈剄涇逕弳脛靚糾廄舊鬮鳩鷲駒舉據鋸懼劇詎屨櫸颶鉅鋦窶齟鵑絹錈鐫雋覺決絕譎玨鈞軍駿皸開凱剴塏愾愷鎧鍇龕閌鈧銬顆殼課騍緙軻鈳錁頷墾懇齦鏗摳庫褲嚳塊儈鄶噲膾寬獪髖礦曠況誆誑鄺壙纊貺虧巋窺饋潰匱蕢憒聵簣閫錕鯤擴闊蠐蠟臘萊來賴崍徠淶瀨賚睞錸癩籟藍欄攔籃闌蘭瀾讕攬覽懶纜爛濫嵐欖斕鑭襤瑯閬鋃撈勞澇嘮嶗銠鐒癆樂鰳鐳壘類淚誄縲籬貍離鯉禮麗厲勵礫歷瀝隸儷酈壢藶蒞蘺嚦邐驪縭櫪櫟轢礪鋰鸝癘糲躒靂鱺鱧倆聯蓮連鐮憐漣簾斂臉鏈戀煉練蘞奩瀲璉殮褳襝鰱糧涼兩輛諒魎療遼鐐繚釕鷯獵臨鄰鱗凜賃藺廩檁轔躪齡鈴靈嶺領綾欞蟶鯪餾劉瀏騮綹鎦鷚龍聾嚨籠壟攏隴蘢瀧瓏櫳朧礱樓婁摟簍僂蔞嘍嶁鏤瘺耬螻髏蘆盧顱廬爐擄鹵虜魯賂祿錄陸壚擼嚕閭瀘淥櫨櫓轤輅轆氌臚鸕鷺艫鱸巒攣孿灤亂臠孌欒鸞鑾掄輪倫侖淪綸論圇蘿羅邏鑼籮騾駱絡犖玀濼欏腡鏍驢呂鋁侶屢縷慮濾綠櫚褸鋝嘸媽瑪碼螞馬罵嗎嘜嬤榪買麥賣邁脈勱瞞饅蠻滿謾縵鏝顙鰻貓錨鉚貿麼沒鎂門悶們捫燜懣鍆錳夢瞇謎彌覓冪羋謐獼禰綿緬澠靦黽廟緲繆滅憫閩閔緡鳴銘謬謨驀饃歿鏌謀畝鉬吶鈉納難撓腦惱鬧鐃訥餒內擬膩鈮鯢攆輦鯰釀鳥蔦裊聶嚙鑷鎳隉蘗囁顢躡檸獰寧擰濘苧嚀聹鈕紐膿濃農儂噥駑釹諾儺瘧歐鷗毆嘔漚謳慪甌盤蹣龐拋皰賠轡噴鵬紕羆鈹騙諞駢飄縹頻貧嬪蘋憑評潑頗釙撲鋪樸譜鏷鐠棲臍齊騎豈啟氣棄訖蘄騏綺榿磧頎頏鰭牽釬鉛遷簽謙錢鉗潛淺譴塹僉蕁慳騫繾槧鈐槍嗆墻薔強搶嬙檣戧熗錆鏘鏹羥蹌鍬橋喬僑翹竅誚譙蕎繰磽蹺竊愜鍥篋欽親寢鋟輕氫傾頃請慶撳鯖瓊窮煢蛺巰賕蟣鰍趨區軀驅齲詘嶇闃覷鴝顴權勸詮綣輇銓卻鵲確闋闕愨讓饒擾繞蕘嬈橈熱韌認紉飪軔榮絨嶸蠑縟銣顰軟銳蜆閏潤灑薩颯鰓賽傘毿糝喪騷掃繅澀嗇銫穡殺剎紗鎩鯊篩曬釃刪閃陜贍繕訕姍騸釤鱔墑傷賞坰殤觴燒紹賒攝懾設厙灄畬紳審嬸腎滲詵諗瀋聲繩勝師獅濕詩時蝕實識駛勢適釋飾視試謚塒蒔弒軾貰鈰鰣壽獸綬樞輸書贖屬術樹豎數攄紓帥閂雙誰稅順說碩爍鑠絲飼廝駟緦鍶鷥聳慫頌訟誦擻藪餿颼鎪蘇訴肅謖穌雖隨綏歲誶孫損筍蓀猻縮瑣鎖嗩脧獺撻闥鉈鰨臺態鈦鮐攤貪癱灘壇譚談嘆曇鉭錟頇湯燙儻餳鐋鏜濤絳討韜鋱騰謄銻題體屜緹鵜闐條糶齠鰷貼鐵廳聽烴銅統慟頭鈄禿圖釷團摶頹蛻飩脫鴕馱駝橢籜鼉襪媧膃彎灣頑萬紈綰網輞韋違圍為濰維葦偉偽緯謂衛諉幃闈溈潿瑋韙煒鮪溫聞紋穩問閿甕撾蝸渦窩臥萵齷嗚鎢烏誣無蕪吳塢霧務誤鄔廡憮嫵騖鵡鶩錫犧襲習銑戲細餼鬩璽覡蝦轄峽俠狹廈嚇硤鮮纖賢銜閑顯險現獻縣餡羨憲線莧薟蘚峴獫嫻鷴癇蠔秈躚廂鑲鄉詳響項薌餉驤緗饗蕭囂銷曉嘯嘵瀟驍綃梟簫協挾攜脅諧寫瀉謝褻擷紲纈鋅釁興陘滎兇洶銹繡饈鵂虛噓須許敘緒續詡頊軒懸選癬絢諼鉉鏇學謔澩鱈勛詢尋馴訓訊遜塤潯鱘壓鴉鴨啞亞訝埡婭椏氬閹煙鹽嚴巖顏閻艷厭硯彥諺驗厴贗儼兗讞懨閆釅魘饜鼴鴦楊揚瘍陽癢養樣煬瑤搖堯遙窯謠藥軺鷂鰩爺頁業葉靨謁鄴曄燁醫銥頤遺儀蟻藝億憶義詣議誼譯異繹詒囈嶧飴懌驛縊軼貽釔鎰鐿瘞艤蔭陰銀飲隱銦癮櫻嬰鷹應纓瑩螢營熒蠅贏穎塋鶯縈鎣攖嚶瀅瀠瓔鸚癭頦罌喲擁傭癰踴詠鏞優憂郵鈾猶誘蕕銪魷輿魚漁娛與嶼語獄譽預馭傴俁諛諭蕷崳飫閾嫗紆覦歟鈺鵒鷸齬鴛淵轅園員圓緣遠櫞鳶黿約躍鑰粵悅閱鉞鄖勻隕運蘊醞暈韻鄆蕓惲慍紜韞殞氳雜災載攢暫贊瓚趲鏨贓臟駔鑿棗責擇則澤賾嘖幘簀賊譖贈綜繒軋鍘閘柵詐齋債氈盞斬輾嶄棧戰綻譫張漲帳賬脹趙詔釗蟄轍鍺這謫輒鷓貞針偵診鎮陣湞縝楨軫賑禎鴆掙睜猙爭幀癥鄭證諍崢鉦錚箏織職執紙摯擲幟質滯騭櫛梔軹輊贄鷙螄縶躓躑觶鐘終種腫眾鍾謅軸皺晝驟紂縐豬諸誅燭矚囑貯鑄駐佇櫧銖專磚轉賺囀饌顳樁莊裝妝壯狀錐贅墜綴騅縋諄準著濁諑鐲茲資漬諮緇輜貲眥錙齜鯔蹤總縱傯鄒諏騶鯫詛組鏃鉆纘躦鱒翺並蔔沈醜澱叠鬥範幹臯矽櫃後夥稭傑訣誇裏淩麽黴撚淒扡聖屍擡塗窪餵汙鍁鹹蠍彜湧遊籲禦願嶽雲竈紮劄築於誌註雕訁譾郤猛氹阪壟堖垵墊檾蕒葤蓧蒓菇槁摣咤唚哢噝噅撅劈謔襆嶴脊仿僥獁麅餘餷饊饢楞怵懍爿漵灩混濫瀦淡寧糸絝緔瑉梘棬案橰櫫軲軤賫膁腖飈糊煆溜湣渺碸滾瞘鈈鉕鋣銱鋥鋶鐦鐧鍩鍀鍃錇鎄鎇鎿鐝鑥鑹鑔穭鶓鶥鸌癧屙瘂臒襇繈耮顬蟎麯鮁鮃鮎鯗鯝鯴鱝鯿鰠鰵鱅鞽韝齇麽獣"

Util = {};

--获取文件名
Util.getFileNameFromUrl = function(url)
    if url == nil then
        return
    end
    local files = string.split(url, '/');
    if #files > 0 then
        local fileName = files[#files];
        if fileName then    
            return fileName;
        end
    end
end

--金豆数量转换
--最大显示位数6，超出6位后，用万代替，尾数为万超出4位后，用亿代替，小数点保留2位
Util.convMoneyIU = function(num)
    local ret;
    if(num>=1000000  and num<=9999999) then
	  local tmpNum = num / 10000;
	  ret = string.format("%.2f万",tmpNum);
	elseif (num >=100000000) then
	  local tmpNum = num / 100000000;
	  ret = string.format("%.2f亿",tmpNum);
	else
	  ret = string.format("%d",num);
	end
	return ret;
end
--取整数部分
Util.getCeil = function(num)
    
    if num <= 0 then
       return math.ceil(num);
    end
    if math.ceil(num) == num then
       num = math.ceil(num);
    else
       num = math.ceil(num) - 1;
    end
    return num;
end

--字符大小
Util.utfstrlen=function(str)
    if str == nil then return 0 end
    local len = #str;
    local left = len;
    local cnt = 0;
    local arr={0,0xc0,0xe0,0xf0,0xf8,0xfc};
    while left ~= 0 do
        local tmp=string.byte(str,-left);
		if(tmp ==nil) then
		  break
		end
        local i=#arr;
        while arr[i] do
            if tmp>=arr[i] then left=left-i;break;end
            i=i-1;
        end
        cnt=cnt+1;
    end
    return cnt;
end

Util.getUTFTextString=function(msg,start,length)
    for k = start,string.len(msg) do
        local g = Util.truncateUTF8String(msg,start,k)
        if Util.utfstrlen(g) == length then
            return g,k
        end
    end
end	

--lua中截取UTF8字符串的方法（无乱码） 
Util.truncateUTF8String=function(s,start,n)
    local dropping = string.byte(s, n+1)
	if not dropping then return s end    
    if dropping ~= nil then
        if dropping >= 128 and dropping < 192 then
            return Util.truncateUTF8String(s, start,n-1)
        end
    end
    return string.sub(s, start, n)
end

--取出字符宽度
Util.getFontWidth =function(msg,fontSize)
    local len = Util.utfstrlen(msg)
	local zhLen = 0
	local engLen =0
	local total  = #msg
	local zhNum =0
    if len <  total then--说明里面有中文
        zhNum = (#msg - len)/2
        zhLen = zhNum*2			
    end 
	if( zhNum > 0) then
	   engLen = total - zhNum*3
	else
	   engLen= len
	end	
    return (zhLen+engLen) * fontSize
end

--取出字符宽度，字符个数
Util.getTextWidth=function(value,fontSize)
    if value == nil then return 0 end
    local len = Util.utfstrlen(value)
    local msgEnd,charPos = Util.getUTFTextString(value,0,len)  
    return Util.getFontWidth(msgEnd,fontSize),len
end

--
Util.split=function( str, splitchar )
    local arr = {}
    local head = 1
    local tail = nil
    while true do
        tail, _ = str:find(splitchar,head )
        if tail == nil then
            arr[ 1 + #arr ] = str:sub( head, -1 )
            break
        end
        arr[ 1 + #arr ] = str:sub( head, tail - 1 )
        head = tail + 1
    end
    return arr
end

--
Util.readCSV = function(fileName)
	local path = cc.FileUtils:getInstance():fullPathForFilename("res/csv/" .. fileName)

	local csv = {}
	
	if path ~= string.format("res/csv/%s",fileName) then
        local tmpIndex=1;
		for line in io.lines(path) do
            if(tmpIndex ~=2) then
               table.insert(csv,Util.split(line,","))
            end
            tmpIndex =tmpIndex+1
		end
	end

	return csv
end

--CSV转LUA
Util.CSV2Table = function(fileName)
    if device.platform == "windows" then
	  --return
	end
	
	local csv = Util.readCSV(fileName)

	if #csv > 0 then
		local path = cc.FileUtils:getInstance():fullPathForFilename("res/csv/" .. fileName)
		local path_root = string.sub( path , 1, -string.len(fileName) - 10)

		local table_path = path_root .. "/res/csv/" .. string.sub(fileName,1,-4) .. "lua"
		local file = io.open(table_path, "w")
		file:write( string.sub(fileName,1,-5) .. " ={\n" )
		for i , line in pairs(csv) do
			if i > 1 then
				file:write( "  [" .. line[1] .. "] = {")
				for m, element in pairs(line) do
					if m > 0 then
					    local keyText=csv[1][m];
						file:write(keyText .. "=")

						if tonumber(string.sub(element,1,1)) == nil then
							file:write("\"")
						end

						file:write(element)

						if tonumber(string.sub(element,1,1)) == nil then
							file:write("\"")
						end
					end
					
					if m ~=0 and m ~= #line then
						file:write(", ")
					end
				end

				file:write("}")
			end
			
			if i ~= 1 and i ~= #csv then
				file:write(", ")
			end
			
			file:write("\n")
		end

		file:write("}\n")
		file:close()
	end
end

--计算一定宽度下再求文本高度
Util.getTextHeight = function(strText,fontName,fontSize,width)
     local h= 0;
    if(width>0) then
		local tmpLabel= cc.LabelTTF:create(strText,fontName,fontSize);--ccui.Text:create(self.xin_text:getString(),self.xin_text:getFontName(),self.xin_text:getFontSize());
		local nLine = math.ceil(tmpLabel:getContentSize().width / width) -- math.ceil(w / self.xin_text:getContentSize().width) 
		h = nLine*fontSize;--计算文本高度 12为每行文本偏移
		Log.i("text height.....%d",h)
	end
	return h;
end

--计算一定宽度下再求文本宽度
Util.getTextToWidth = function(strText,fontName,fontSize)
    local w= 0;
	local tmpLabel= cc.LabelTTF:create(strText,fontName,fontSize);
	w = tmpLabel:getContentSize().width 
	Log.i(w)
	
	return w;
end

--1：sum|2：sum 的格式
Util.analyzeString = function(strText)
   local retV={};
   if(strText==nil or strText=="")then return retV end
   
   local retTable = Util.split(strText,"|");
   for k,v in pairs(retTable) do
     local retTable2 = Util.split(v,":");
	 local tmpData={};
	 tmpData.id = retTable2[1];
	 tmpData.num = retTable2[2];
     table.insert(retV,tmpData)
   end
   return retV
end

Util.analyzeString_2 = function(strText)
   local retV={};
   if(strText==nil or strText=="")then return retV end
   local retTable = Util.split(strText,"|");
   return retTable
end
--下划线区分组
Util.analyzeString_3 = function(strText)
    local retV = {};
    if (strText == nil or strText == "" ) then return retV end
    local retTable = Util.split(strText,"_")
    return retTable
end

--连续切割
--...是分隔符
Util.analyzeStringEx = function(strText, ...)
    local argTab = {...}
    local idx = 1
    if #argTab == 0 then return {strText} end

    local call
    call = function(str, idx)
        if idx > #argTab then return str end

        if(str==nil or str=="")then return {} end
        local retTable
        if argTab[idx] == '' then
            retTable = {str}
        else
            retTable = Util.split(str, argTab[idx]);
        end        

        for i,v in ipairs(retTable) do
            retTable[i] = call(v, idx + 1)
        end
        return retTable
    end

    return call(strText, 1)
end

--替换查找符号信息
Util.replaceFindInfo=function(text,findFlag,replaceDataList)
	local retText=nil
	local bTrue=true
	local bFind=nil
    local bFind2 = nil
	local index=1
    local startIndex = 1
    local strs = {}
	while bTrue do
		bFind, bFind2 = string.find(text,findFlag, startIndex)
		if(bFind==nil or index>#replaceDataList) then
            local sub = string.sub(text, startIndex, string.len(text))
            table.insert(strs, sub)
		    return table.concat(strs)
		end

        local sub = string.sub(text, startIndex, bFind - 1)
        startIndex = bFind2 + 1

        table.insert(strs, sub)
        table.insert(strs, replaceDataList[index])

		index = index +1   
	end 	
end

--时间类型转换和00:00:00格式化
Util.timeFormat = function(totalTime)
	local hour = math.floor(totalTime/3600)
	local minute = math.floor(math.mod(totalTime,3600)/60)
	local second = 	math.mod(math.mod(totalTime,3600),60)
	--将int类型转换为string类型
	hour = hour..""
	minute = minute..""
	second = second..""
	--当显示数字为个位数时，前位用0补上
	if string.len(hour) == 1 then
		hour = "0"..hour
	end
	if string.len(minute) == 1 then
		minute = "0"..minute
	end
	if string.len(second) == 1 then
		second = "0"..second
	end
	return hour,minute,second
end

--时间类型转换和00:00:00格式化
Util.timeFormatNew = function(totalTime)
    local day = math.modf(totalTime/(3600*24))
    if day > 0 then
        return day.."天",true
    end
    local hour, minute, second
    hour,minute     = math.modf( totalTime / 3600 )
    minute          = math.modf( minute * 60 )
    second          = totalTime % 60
    return string.format("%02d:%02d:%02d", hour, minute, second)
end

Util.timeFormatNew2 = function(totalTime)
    local day = math.modf(totalTime/(3600*24))
    if day > 0 then
        return day.."天"
    end
    local hour, minute, second
    hour,minute     = math.modf( totalTime / 3600 )
    minute          = math.modf( minute * 60 )
    second          = totalTime % 60
    return string.format("%02d:%02d", hour, minute)
end

Util.setGrey = function(node,index)
   local vertDefaultSource = [[

            attribute vec4 a_position;
            attribute vec2 a_texCoord;
            attribute vec4 a_color;  

            #ifdef GL_ES
                varying lowp vec4 v_fragmentColor;
                varying mediump vec2 v_texCoord;
            #else
                varying vec4 v_fragmentColor;
                varying vec2 v_texCoord;
            #endif 

            void main()
            {
                gl_Position = CC_PMatrix * a_position; 
                v_fragmentColor = a_color;
                v_texCoord = a_texCoord;
            }

            ]]

    local pszFragSource = [[

        #ifdef GL_ES 
                        precision mediump float;
                #endif 
                varying vec4 v_fragmentColor; 
                varying vec2 v_texCoord; 

                void main(void) 
                { 
                    vec4 c = texture2D(CC_Texture0, v_texCoord);
                    gl_FragColor.xyz = vec3(0.4*c.r + 0.4*c.g +0.4*c.b);
                    gl_FragColor.w = c.w; 
                }

                ]]

    local psRemoveGrayShader = [[
       #ifdef GL_ES
        precision mediump float;
        #endif
        varying vec4 v_fragmentColor;
        varying vec2 v_texCoord;
        void main(void)
        {
            gl_FragColor = texture2D(CC_Texture0, v_texCoord);
        } 
    ]]
    local pProgram = nil
    if index == 1 then
        pProgram = cc.GLProgram:createWithByteArrays(vertDefaultSource, pszFragSource)
    else
        pProgram = cc.GLProgram:createWithByteArrays(vertDefaultSource, psRemoveGrayShader)
    end
--    if index == 1 then
        pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_POSITION, cc.VERTEX_ATTRIB_POSITION)
        pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_COLOR, cc.VERTEX_ATTRIB_COLOR)
        pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_TEX_COORD, cc.VERTEX_ATTRIB_FLAG_TEX_COORDS)
--    else
--        pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_POSITION,cc.VERTEX_ATTRIB_POSITION)
--        pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_COLOR,cc.VERTEX_ATTRIB_COLOR)
--        pProgram:bindAttribLocation(cc.ATTRIBUTE_NAME_TEX_COORD,cc.VERTEX_ATTRIB_TEX_COORD)
--    end
    pProgram:link()
    pProgram:updateUniforms()
    node:setGLProgram(pProgram) 
end

Util.setGreyAll = function(node, ok)
    Util.setGrey(node, ok)
    for i,v in ipairs(node:getChildren()) do
        Util.setGreyAll(v, ok)
    end
end

--[[
创建红点
parent:红点的父节点。
isShow:是否显示，false :不显示 true :显示
position：位置。
]]

Util.createRedPointTip = function(parent,isShow,position)
	local hongdian = parent:getChildByName("hongdian")
	-- 如果没有红点, 则创建
	if not hongdian then
        if IsPortrait then -- TODO
            hongdian = display.newSprite("hall/main/img_red_dot_2.png")
        else
            hongdian = display.newSprite("hall/main/hongdian.png")
        end
		parent:addChild(hongdian)
		hongdian:setPosition(position)   
		hongdian:setName("hongdian")
	end
	if isShow then
		hongdian:setVisible(true)
	else
		hongdian:setVisible(false)
	end
end

--缩小-放大-停顿--消失 动作
Util.runScaleToHideAction = function(obj,widget,st,ht)
   transition.execute(obj,(cc.Sequence:create(cc.ScaleTo:create(st, 0.9),
		                              cc.ScaleTo:create(st, 1),
									  cc.DelayTime:create(ht),
									  cc.ScaleTo:create(st, 0.1))),{
			onComplete = function() widget:removeFromParent()	end
        });
end

Util.checkChinese = function(str)
    local f = '[\194-\244][\128-\191]*'

    for v in str:gfind(f) do
        local isCon = string.find(kTradChinese, v)
        if isCon ~= nil then
            return true
        end
    end

    return false
end

Util.updateNickName = function(label, str, fontSize, color)
    if label ~= nil and (tolua.type(label) == "cc.Label" or tolua.type(label) == "ccui.Text") then
        str = str and str or ""
        if not fontSize then
            if tolua.type(label) == "ccui.Text" then
                fontSize = label:getFontSize()
            end
        end

        if Util.checkChinese(str) then
            if tolua.type(label) == "cc.Label" then
                label:setSystemFontName("Helvetica-Bold")
                if fontSize then label:setSystemFontSize(fontSize) end
            elseif tolua.type(label) == "ccui.Text" then
                label:setFontName("Helvetica-Bold")
                if fontSize then label:setFontSize(fontSize) end
            end
        end

        label:setString(str)
        if color then label:setColor(color) end
    end
end

function Util.addCardEffect(card, offsetSize)
    if card == nil then return end

    local oW = offsetSize and offsetSize.width or 0
    local oH = offsetSize and offsetSize.height or 0

    local contentSize = card:getContentSize()
    local layer = cc.LayerColor:create(cc.c4b(0, 0, 0, 128), contentSize.width + oW, contentSize.height + oH)
    layer:setAnchorPoint(cc.p(0.5, 0.5))
    layer:setPosition(cc.p(-contentSize.width * 0.5 - oW * 0.5, -contentSize.height * 0.5 - oH * 0.5))
    card:addChild(layer)
end

function Util.checkTableContainObj(tab, obj)
    for i, v in ipairs(tab) do
        if v == obj then
            return true
        end
    end
    return false
end


Util.stringSplit = function(str, delimiter)
    if str==nil or str=='' or delimiter==nil then
        return nil
    end
    
    local result = {}
    for match in (str..delimiter):gmatch("(.-)"..delimiter) do
        table.insert(result, match)
    end
    return result
end


Util.formatClubDiamondSt = function(st)
    if st == 1 then
        return "充足", cc.c4b(5, 196, 167, 255)
    elseif st == 2 then
        return "可用", cc.c4b(0, 179, 0, 255)
    elseif st == 3 then
        return "紧张", cc.c4b(255, 142, 0, 255)
    elseif st == 4 then
        return "不足", cc.c4b(255, 54, 0, 255)
    else
        return "空仓", cc.c4b(255, 0, 144, 255)
    end
end

Util.cutMjName = function(mjName)
    if mjName == nil then return "麻将" end
    local tdhIndex = string.find(mjName, "推倒胡")
    local hzIndex = string.find(mjName, "红中")
    local tmpName = mjName
    if tdhIndex and TUIDAOHU_SUODUAN then --通过推倒胡缩短字段控制
        tmpName = "推倒胡"
    end
    if hzIndex and HONGZHONG_SUODUAN then --通过红中缩短字段控制
        tmpName = "红中麻将"
    end
    return tmpName
end

local formatMatchScoreStr = function(score)
    return (score and score>0) and "+"..tostring(score) or tostring(score)
end

local fromatMatchScoreColor = function(score, winColor, failColor)
    if score and score>0 then
        if IsPortrait then -- TODO
            return winColor and winColor or cc.c3b(255,0,0)
        else
            return winColor and winColor or cc.c3b(255,191,0)
        end
    else
        return failColor and failColor or cc.c3b(38,204,38)
    end
end

Util.isBezelLess = function()
    local visibleWidth = cc.Director:getInstance():getOpenGLView():getFrameSize().width
    local visibleHeight = cc.Director:getInstance():getOpenGLView():getFrameSize().height
    if visibleWidth > visibleHeight then
        if IsPortrait then -- TODO
            return visibleWidth/visibleHeight > 1.78
        else
            return visibleWidth/visibleHeight > 1.9
        end
    else
        if IsPortrait then -- TODO
            return visibleHeight/visibleWidth > 1.78
        else
            return visibleHeight/visibleWidth > 1.9
        end
    end
end

--处理的是战绩列表(50301)的数据 不是战绩局数详情的
Util.formatMatchRecordUserInfo = function(playerData, matchGameID)
    local retTable = clone(playerData)
    retTable.playerName = playerData.niN
    retTable.playerID = playerData.usID
    retTable.score = playerData.ca
    retTable.scoreStr = formatMatchScoreStr(playerData.ca)
    retTable.scoreClr = fromatMatchScoreColor(playerData.ca)
    retTable.headImgUrl = playerData.im

    --地方组扩展麻将战绩处理
    if matchGameID == 10029 then
        if playerData.exM and playerData.exM["putong-" .. playerData.usID] then
            retTable.score = tonumber(playerData.exM["putong-" .. playerData.usID])
            retTable.scoreStr = formatMatchScoreStr(retTable.score)
            retTable.scoreClr = fromatMatchScoreColor(playerData.score)
        end
    elseif matchGameID == 20011 then
        retTable.shengji = playerData.exM.shengji
    end

    return retTable
end

-- 处理bugly上传数据
Util.reportBugly = function(buglyTag, data)
    local report = " Util.reportBugly: "
    if _gameType then
        report = _gameType .. " " .. report
    end
    if GC_GameName then
        report = GC_GameName .. report
    end
    if type(data) == "table" then
        for k, v in pairs(data) do
            report = report .. " " .. k
            if type(v) == "table" then
                report = report .. ": (table) " .. json.encode(v)
            else
                report = report .. ": (type) " .. type(v) .. " (value) " .. v
            end
            report = report  .. " |"
        end
    else
        report = report .. tostring(data)
    end
    Log.i("Util.reportBugly", report)
    if device.platform == "android" then
        if buglyTag and type(buglyTag) == "number" and buglyTag ~= 0 then
            buglySetTag(buglyTag)
        end
        buglyReportLuaException(report, debug.traceback())
    end
end

-- 处理bugly上传数据(详见BuglyLuaAgent.cpp)
Util.reportBuglyLog = function(buglyTag, data, tag, level)
    local report = ""
    if _gameType then
        report = _gameType .. " " .. report
    end
    if GC_GameName then
        report = GC_GameName .. report
    end
    if type(data) == "table" then
        for k, v in pairs(data) do
            report = report .. " " .. k
            if type(v) == "table" then
                report = report .. ": (table) " .. json.encode(v)
            else
                report = report .. ": (type) " .. type(v) .. " (value) " .. v
            end
            report = report  .. " |"
        end
    else
        report = report .. tostring(data)
    end
    Log.i("Util.reportBuglyLog", report)
    if device.platform == "android" then
        if buglyTag and type(buglyTag) == "number" and buglyTag ~= 0 then
            buglySetTag(buglyTag)
        end
        buglyLog(level or 2, tag or "Util.reportBuglyLog", report)
    end
end

local indent = "    "
Util.printName = function(node, indentStr)
    local childrenName = node:getName()
    if childrenName == "" then childrenName = "[noname]" end
    print(indentStr .. childrenName .. "    type(" .. tolua.type(node) .. ")")
end

Util.printChildrenInfo = function(parent, indentStr)
    indentStr = indentStr or ""
    Util.printName(parent, indentStr)
    for k, v in pairs(parent:getChildren()) do
        Util.printChildrenInfo(v, indentStr .. indent)
    end
end

Util.printAllChildren = function(parent)
    if not DEBUG_MODE then return end
    if not parent then
        print("ERROR!!! parent is nil")
        return
    elseif type(parent) ~= "userdata" then
        print("ERROR!!! parent type: " .. type(parent))
        return
    elseif not parent.getChildren then
        print("ERROR!!! no getChildren function")
        return
    end
    print("")
    print("Util.printAllChildren start ----------------")
    Util.printChildrenInfo(parent, "")
    print("Util.printAllChildren finish ---------------")
    print("")
end

Util.debug_shield_value = function(value)
    -- Log.i("DEBUG_SHIELD_VALUE",DEBUG_SHIELD_VALUE)
    if DEBUG_SHIELD_VALUE and #DEBUG_SHIELD_VALUE> 0 then
        for i,v in pairs(DEBUG_SHIELD_VALUE) do
            if v == value then
                return true
            end
        end
        return false
    else
        return false
    end
end

-- 比较两个table的值是否相同
Util.table_eq = function(table1, table2)
   local avoid_loops = {}
   local function recurse(t1, t2)
      -- compare value types
      if type(t1) ~= type(t2) then return false end
      -- Base case: compare simple values
      if type(t1) ~= "table" then return t1 == t2 end
      -- Now, on to tables.
      -- First, let's avoid looping forever.
      if avoid_loops[t1] then return avoid_loops[t1] == t2 end
      avoid_loops[t1] = t2
      -- Copy keys from t2
      local t2keys = {}
      local t2tablekeys = {}
      for k, _ in pairs(t2) do
         if type(k) == "table" then table.insert(t2tablekeys, k) end
         t2keys[k] = true
      end
      -- Let's iterate keys from t1
      for k1, v1 in pairs(t1) do
         local v2 = t2[k1]
         if type(k1) == "table" then
            -- if key is a table, we need to find an equivalent one.
            local ok = false
            for i, tk in ipairs(t2tablekeys) do
               if table_eq(k1, tk) and recurse(v1, t2[tk]) then
                  table.remove(t2tablekeys, i)
                  t2keys[tk] = nil
                  ok = true
                  break
               end
            end
            if not ok then return false end
         else
            -- t1 has a key which t2 doesn't have, fail.
            if v2 == nil then return false end
            t2keys[k1] = nil
            if not recurse(v1, v2) then return false end
         end
      end
      -- if t2 has a key which t1 doesn't have, fail.
      if next(t2keys) then return false end
      return true
   end
   return recurse(table1, table2)
end

-- 一定时间内, 禁止按钮的点击事件
Util.disableNodeTouchWithinTime = function(node, time, notGray)
    -- 设置默认时间
    time = time or 1
    -- 按钮变灰
    if not notGray then node:setColor(cc.c3b(168, 168, 168)) end
    -- 禁用点击
    node:setTouchEnabled(false)
    if node._enableHandler then scheduler.unscheduleGlobal(node._enableHandler) end
    -- 启用点击的回调
    node._enableHandler = scheduler.performWithDelayGlobal(function()
            if tolua.isnull(node) then return end
            if not notGray then node:setColor(cc.c3b(255, 255, 255)) end
            node:setTouchEnabled(true)
            -- 清理点击的回调
            if node._enableHandler then node._enableHandler = nil end
        end, time)
end


Util.checkNetWork = function(onFinish)
    if not onFinish then return end
    local isEnter = false
    local getNetType = function(info)
        if isEnter then
            return
        else
            isEnter = true
            if info.type == "无" or info.type == "无网络" then
                onFinish(0)
                return
            end
            HttpManager.getTestUrl("https://www.baidu.com", onFinish)
        end
    end
    local data = {}
    data.cmd = NativeCall.CMD_WECHAT_SIGNAL
    NativeCall.getInstance():callNative(data, getNetType)
    -- 为了兼容iphoneX 登陆不上的问题，
    scheduler.performWithDelayGlobal(function()
            if isEnter then
                return
            else
                isEnter = true
                HttpManager.getTestUrl("https://www.baidu.com", onFinish)
            end
        end, 0.5)
end

-- 函数功能: 改变登录/ 更新/ 大厅 界面的logo
-- logoNode: logo的节点
-- 返回值: 无
function Util.changeHallLogo(logoNode, offsetX, offsetY)
    if GLOBAL_DEFINE.HallLogo then
        local margin = logoNode:getLayoutParameter():getMargin()
        local preSize = logoNode:getContentSize()
        logoNode:loadTexture(GLOBAL_DEFINE.HallLogo)
        logoNode:setScale(1.2)
        local nowSize = logoNode:getContentSize()
        margin.left = margin.left + (preSize.width - nowSize.width) * 0.5 + (offsetX or 0)
        margin.top = margin.top + (preSize.height - nowSize.height) * 0.5 - (offsetY or 0)
        -- Log.i("margin", margin)
        logoNode:getLayoutParameter():setMargin(margin)
    end
end